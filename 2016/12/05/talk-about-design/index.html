<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>浅谈设计和架构过程 | 红中的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言程序员大部分的时间都集中在做某个具体功能的实现，大部分的博客和技术论坛都只是谈论着怎么实现一个具体的功能，怎么使用一个新的框架，很少涉及涉及和架构。
事实上是，越来越丰富的框架、第三方模块、开源库，让我们实现一个具体功能变得容易，但是，软件的整体性能和迭代性并没有实质性的改善。
原因很简单，我们没有做好设计和架构，甚至从来做过什么单元测试。
我的意思是，如果我们想持续把程序员作为一个职业或者兴">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈设计和架构过程">
<meta property="og:url" content="https://wuqingtao.github.io/2016/12/05/talk-about-design/index.html">
<meta property="og:site_name" content="红中的博客">
<meta property="og:description" content="前言程序员大部分的时间都集中在做某个具体功能的实现，大部分的博客和技术论坛都只是谈论着怎么实现一个具体的功能，怎么使用一个新的框架，很少涉及涉及和架构。
事实上是，越来越丰富的框架、第三方模块、开源库，让我们实现一个具体功能变得容易，但是，软件的整体性能和迭代性并没有实质性的改善。
原因很简单，我们没有做好设计和架构，甚至从来做过什么单元测试。
我的意思是，如果我们想持续把程序员作为一个职业或者兴">
<meta property="og:updated_time" content="2016-12-18T14:05:47.286Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浅谈设计和架构过程">
<meta name="twitter:description" content="前言程序员大部分的时间都集中在做某个具体功能的实现，大部分的博客和技术论坛都只是谈论着怎么实现一个具体的功能，怎么使用一个新的框架，很少涉及涉及和架构。
事实上是，越来越丰富的框架、第三方模块、开源库，让我们实现一个具体功能变得容易，但是，软件的整体性能和迭代性并没有实质性的改善。
原因很简单，我们没有做好设计和架构，甚至从来做过什么单元测试。
我的意思是，如果我们想持续把程序员作为一个职业或者兴">
  
    <link rel="alternate" href="/atom.xml" title="红中的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">红中的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://wuqingtao.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-talk-about-design" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2016/12/05/talk-about-design/" class="article-date">
  <time datetime="2016-12-05T13:39:35.000Z" itemprop="datePublished">2016-12-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      浅谈设计和架构过程
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>程序员大部分的时间都集中在做某个具体功能的实现，大部分的博客和技术论坛都只是谈论着怎么实现一个具体的功能，怎么使用一个新的框架，很少涉及涉及和架构。</p>
<p>事实上是，越来越丰富的框架、第三方模块、开源库，让我们实现一个具体功能变得容易，但是，软件的整体性能和迭代性并没有实质性的改善。</p>
<p>原因很简单，我们没有做好设计和架构，甚至从来做过什么单元测试。</p>
<p>我的意思是，如果我们想持续把程序员作为一个职业或者兴趣，让我们现在就开始时刻关注和提高自己的设计和架构能力。</p>
<p>好的架构应该达到以下目的：</p>
<ul>
<li>有效缩短项目开发周期。</li>
<li>最大可能减少各种bug。</li>
<li>低成本的版本迭代。</li>
<li>很好的优化开发团队结构。</li>
</ul>
<p>一个快速完整的架构历程应该是：</p>
<ul>
<li>目录结构设计。</li>
<li>模块切分。</li>
<li>模块接口定义。</li>
<li>模块单元测试设计。</li>
<li>编译自动化。</li>
<li>部署自动化。</li>
</ul>
<p>本文将以一个简单的web应用的例子，串联整个软件的开始周期，描述自己对设计、架构及单元测试的理解。</p>
<h1 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h1><p>假如需求是这样的：做一个web页面，功能类似于一个心情记事本，包括消息展示、发布和获取，点击<a href="http://120.55.185.245/message/" target="_blank" rel="external">紅中随笔</a>查看。</p>
<h1 id="工程名称"><a href="#工程名称" class="headerlink" title="工程名称"></a>工程名称</h1><p>工程名称将是整个项目生命周期最多被引用到的名词，所以多花点时间琢磨工程名称很要必要。</p>
<p>合适的工程名称应该满足：</p>
<ul>
<li>简洁，不要过于冗长。</li>
<li>又不能太过简洁，能够大致描述项目目的。</li>
<li>不要用拼音或简拼。</li>
<li>也不要过分纠结。</li>
</ul>
<p>我们把这个工程命名为messag，当然msg也不错，但是message还是太泛，我们再给他加点限制，message of hongzhong，也就是hz-message，至于是-还是_，都可以。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hz-message</div></pre></td></tr></table></figure></p>
<h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><p>所有项目的源文件都将位于各个目录中，各个文件之间互相依赖调用，我们不希望在开发过程中发现目录结构或是目录名称定义不合理再来修改，而致代码日志混乱。</p>
<p>目录结构的定义应该满足以下原则：</p>
<ul>
<li>各个子系统分开，如前端（web）和后端（server）。</li>
<li>每个子系统的不同组件分开，如源码（src）、测试（test）、配置（conf）和库目录（libs）。</li>
<li>每个组件的不同类型归类，如js、css，utils等。</li>
</ul>
<p>目录名称的命名应该：</p>
<ul>
<li>遵循惯例，如html、js、css、src、test、conf、libs、utils、bin、obj、tmp等。</li>
<li>惯例以外的名称不要过分简洁，亦不要太臃肿。</li>
<li>忌拼音或简拼，很容易不知道是什么意思。</li>
</ul>
<p>对于hz-message，前端我们命令为web，www看上去更像是一个部署目录，html不足以涵盖前端的概念。当然，在这里，更好的做法应该是app/web，app意味前端，而前端可能会有web，也可能有android和ios。测试目录是必须的，因此web具备有两个子目录src和test。src分为html、js和css不同类型，hz-message把html文件直接至于src目录下也OK，毕竟js和css都归html调用。对于test，也应该分为html、js和css，hz-message虽然仅做了部分js相关的测试，考虑后续也许会做html相关测试，所以仅有js目录。</p>
<p>后端命名为server，srv好像也不错，不过我个人觉得太缩写。对于后端，虽然实际的hz-message实现了多个语言版本，这里只说java，server理所当然的分为src、test、conf和libs，conf和libs最好不要放在src下面，因为test中测试程序也可能调用conf和libs，同时也方便后续编译和打包。对于，src和test，我们增加层级域名的结构hz/message。</p>
<p>最后看上去是这样的：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">hz-message</div><div class="line">├── server</div><div class="line">│   ├── conf</div><div class="line">│   ├── src</div><div class="line">│   │   └── hz</div><div class="line">│   │       └── message</div><div class="line">│   └── <span class="built_in">test</span></div><div class="line">│       └── hz</div><div class="line">│           └── message</div><div class="line">└── web</div><div class="line">    ├── src</div><div class="line">    │   ├── css</div><div class="line">    │   └── js</div><div class="line">    └── <span class="built_in">test</span></div><div class="line">        └── js</div></pre></td></tr></table></figure></p>
<h1 id="模块切分"><a href="#模块切分" class="headerlink" title="模块切分"></a>模块切分</h1><p>我们先说server。</p>
<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><p>既然是服务，我们首先需要一个模块来实现服务入口。结构的搭建是hz-message演示的重点，所以我们不会使用tomcat来帮忙，当然也不会重新从底层开始写一个服务。Servt是java服务最合适的标准，我们使用Jetty嵌入式组件来实现hz-message java服务。</p>
<p>我们把这个模块命名为ServletServer，直接命名为Server也没问题，不过我想明确他是一个Servlet服务，而不是fcgi服务。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">hz-message</div><div class="line">└── server</div><div class="line">    └── src</div><div class="line">        └── hz</div><div class="line">            └── message</div><div class="line">                └── ServletServer.java</div></pre></td></tr></table></figure></p>
<h3 id="ServletServer"><a href="#ServletServer" class="headerlink" title="ServletServer"></a>ServletServer</h3><p>接下来，我们按照Jetty Servlet规范写框架：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Servlet服务</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletServer</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * HTTP请求处理Handler</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span> </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String target, Request baseRequest,</span></span></div><div class="line">				HttpServletRequest request, HttpServletResponse response) <span class="keyword">throws</span> IOException,</div><div class="line">				ServletException &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从现在开始，我们的代码将持续注意java代码规范：</p>
<ul>
<li>注释</li>
<li>各种类命名，类、函数、成员变量、参数、临时变量等</li>
<li>各种格式化，空格、换行等</li>
</ul>
<p>OK，接下来我们要在hanlde函数中处理HTTP请求了：</p>
<ul>
<li>POST还是GET</li>
<li>如果是POST，POST的编码和参数规范又是什么，都得定义</li>
<li>我们应该把参数从字符串解析成一个对象模型</li>
<li>这个参数对象谁来处理</li>
<li>处理的结果的对象又是什么模型</li>
<li>接着要把结果对象转换成字符串返回</li>
<li>我们也要处理好各种异常</li>
<li>最后，作为整个Server的，也需要一个main函数来启动Server</li>
</ul>
<p>对于ServletServer，我们进一步演化：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Servlet服务</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletServer</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * HTTP请求处理Handler</div><div class="line">	 */</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span> </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String target, Request baseRequest,</span></span></div><div class="line">				HttpServletRequest request, HttpServletResponse response) <span class="keyword">throws</span> IOException,</div><div class="line">				ServletException &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> [1]处理POST以外的不支持的method, HTTP 501返回</span></div><div class="line">				</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> [2]获取POST请求字符串参数</span></div><div class="line">				String paramStr;</div><div class="line">				</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> [3]将字符串参数转换为参数模型</span></div><div class="line">				JSONObject param = Converter.str2json(paramStr);</div><div class="line">				</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> [4]将参数模型传递给内部处理对象处理</span></div><div class="line">				Message message;</div><div class="line">				JSONObject result = message.request(param);</div><div class="line">				</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> [5]返回结果模型</span></div><div class="line">				String resultStr = Converter.json2str(result);</div><div class="line">				</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> [6]将返回结果模型转换为字符串，HTTP返回</span></div><div class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">				<span class="comment">// <span class="doctag">TODO:</span> [7]内部异常，HTTP 500返回</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建Servlet Server，监听指定端口</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 设置HTTP请求处理Handler</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 启动服务</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 等待退出</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于[1]没什么好说的了，待实现。</p>
<p>对于[2]和[6]需要的字符串，我们要定义输入和输出字符串的的协议，这里，我们定义输入和返回的协议格式为标准json字符串，具体业务规格后续体现。</p>
<p>对于[3]和[5]涉及的参数和返回模型类，我们直接使用org.json.JSONObject，当然具体定义输入和返回的模型类，效率会更好，这里忽略。</p>
<p>但是，我们需要一个转换模块，用于在字符串参数、字符串结果和JSONObject之间做转换，我们我们命名整个转换模块为Converter，他有两个静态函数str2json和json2str来实现转换。</p>
<p>对于[4]，这个内部处理对象应该输入JSONObject参数，处理之后，返回一个JSONObject结果，整个内部对象将处理来自前端的所有请求，这里命名为Message，具备一个request函数。</p>
<p>再考虑异常捕获[7]，对于期望的异常，我们应该各个角度具体实现的时候捕获他，而对于不期望的异常，意味着内部错误，比如mysqldown了，或者是一个bug，但是我们不能把这些异常抛给前端用户，因此，合适的做法在最外层捕获，同时做好日志记录（包括详细的调用栈信息），返回HTTP 500。</p>
<h3 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h3><p>ServletServer的设计暂时到此，接下来，我们要明确把Convert的定义出来：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 处理字符串和json之间的转换</div><div class="line"> */</div><div class="line">public class Converter &#123;</div><div class="line">	/**</div><div class="line">	 * 字符串转json</div><div class="line">	 * </div><div class="line">	 * @param str 字符串</div><div class="line">	 * @<span class="built_in">return</span> &#123;json对象, &#123;<span class="string">"status"</span>: <span class="string">"&lt;错误状态&gt;"</span>, <span class="string">"message"</span>: <span class="string">"&lt;错误描述&gt;"</span>&#125;&#125;</div><div class="line">	 */</div><div class="line">	public static Object[] str2json(String str) &#123;</div><div class="line">		// TODO</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * json转字符串</div><div class="line">	 * </div><div class="line">	 * @param json json对象</div><div class="line">	 * @<span class="built_in">return</span> 字符串</div><div class="line">	 */</div><div class="line">	public static String json2str(JSONObject obj) &#123;</div><div class="line">		// TODO</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h3><p>轮到Message模块了，最初的Message对象是：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 消息类</div><div class="line"> * &lt;p&gt;消息类用于处理用户的消息请求，包括添加、查询、修改和删除操作</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 处理请求</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> param &#123;"type", "&lt;type值&gt;", ...&#125;</div><div class="line">	 * <span class="doctag">@return</span> &#123;"status": "&lt;状态&gt;", "message": "&lt;错误描述&gt;", "data": &lt;结果&gt;&#125;</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">    <span class="function"><span class="keyword">public</span> JSONObject <span class="title">request</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来的问题是，我们要怎么实现request，hz-message使用mysql管理后台数据，那我们这个Message实现的时候应该需要mysql相关的连接对象和数据表的操作等。但是，也许我们要提前考虑一些扩展性的事，也许我们以后想换成mongodb来实现，这像是一个典型的多态设计，既然是多态，我们要把数据访问逻辑抽象化，我们不希望以后把mysql换成mongodb时，还要修改Message，颠覆Message的测试代码。</p>
<p>我们先简单定义一下mysql数据库名称（message）和业务唯一相关的消息表（post）。</p>
<p>考虑后续我们也许会给hz-message加上用户的概念，我们最好是把数据库的连接和消息的处理逻辑分为两个模块：</p>
<ul>
<li>Holder，抽象数据库连接</li>
<li>Post，抽象消息表的操作</li>
</ul>
<p>Holder具备一个inst接口，用于返回一个Object对象，对于mysql，他实际是一个mysql连接对象。</p>
<p>Post根据功能业务，定义getCount、getAll、getById、add、modify、remove接口。</p>
<p>至此，Message应该看上去是这样的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 消息类</div><div class="line"> * &lt;p&gt;</div><div class="line"> * 消息类用于处理用户的消息请求，包括添加、查询、修改和删除操作</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(Holder holder, Post post)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 处理请求</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> param &#123;"type", "&lt;type值&gt;", ...&#125;</div><div class="line">	 * <span class="doctag">@return</span> &#123;"status": "&lt;状态&gt;", "message": "&lt;错误描述&gt;", "data": &lt;结果&gt;&#125;</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">    <span class="function"><span class="keyword">public</span> JSONObject <span class="title">request</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		String type = param[<span class="string">"type"</span>];</div><div class="line">	</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> 根据不同的type值来分发调用Post的对应接口</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Checker"><a href="#Checker" class="headerlink" title="Checker"></a>Checker</h3><p>等等，也许param不存<code>type</code>，或者<code>type</code>的值根本是String，我必须正确处理，最好我们需要一个具体的参数校验模块Checker，而且这块Checker将不仅仅是校验<code>type</code>参数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 校验请求参数是否合法</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Checker</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 校验type参数是否合法</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> param &#123;"type": "&lt;type值&gt;", ...&#125;</div><div class="line">	 * <span class="doctag">@return</span> &#123;"&lt;type值&gt;", &#123;"status": "&lt;错误状态&gt;", "message", "&lt;错误描述&gt;:&#125;&#125;</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Object[] checkParamType(JSONObject param) &#123;</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> 考虑各种type异常值的处理</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们干脆把各种type值直接定义了，这时Message将看起来是这样的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 消息类</div><div class="line"> * &lt;p&gt;</div><div class="line"> * 消息类用于处理用户的消息请求，包括添加、查询、修改和删除操作</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(Holder holder, Post post)</span> </span>&#123;</div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span></span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 处理请求</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> param &#123;"type", "&lt;type值&gt;", ...&#125;</div><div class="line">	 * <span class="doctag">@return</span> &#123;"status": "&lt;状态&gt;", "message": "&lt;错误描述&gt;", "data": &lt;结果&gt;&#125;</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> JSONObject <span class="title">request</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 校验type参数</span></div><div class="line">		Object[] typeErr = Checker.checkParamType(param);</div><div class="line">		String type = (String) typeErr[<span class="number">0</span>];</div><div class="line">		</div><div class="line">		<span class="comment">// 根据不同type值调用post对象处理</span></div><div class="line">		<span class="keyword">if</span> (type.equals(<span class="string">"get_post_count"</span>)) &#123;</div><div class="line">			<span class="keyword">return</span> _post.getCount();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"get_all_post"</span>)) &#123;</div><div class="line">			<span class="keyword">return</span> _post.getAll();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"get_post_by_id"</span>)) &#123;</div><div class="line">			<span class="keyword">return</span> _post.getById(param);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"add_post"</span>)) &#123;</div><div class="line">			<span class="keyword">return</span> _post.add(param);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"modify_post"</span>)) &#123;</div><div class="line">			<span class="keyword">return</span> _post.modify(param);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"remove_post"</span>)) &#123;</div><div class="line">			<span class="keyword">return</span> _post.remove(param);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"status\": \"invalid_parameter\", \"message\": \"`type` is invalid.\"&#125;"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>另外一个问题是，Message对象的创建过程，需要实例化具体的Holder和Post，考虑mysql和mongodb两种实现方式，显示创建Message过程是一个典型工厂模式，我们将需要一个MessageCreator，MessageCreator的设计将涉及具体的Holder和Post的实现，我们接下来先深入Holder、MysqlHolder和Post、MysqlPost。</p>
<h3 id="Holder"><a href="#Holder" class="headerlink" title="Holder"></a>Holder</h3><p>Java是相对其他脚本语言（js、php、python等）的一种强类型语言，对于强类型语言的多态，我们需要抽象类，Holder来定义了Holder需要的接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 实体类接口</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Holder</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 获取实体内部对象</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@return</span> 实体内部对象</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">inst</span><span class="params">()</span></span>;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 销毁数据实体</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 关闭数据实体</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，inst的返回，对于mysql来说就是一个mysql连接对象，但是对于mongodb来说则是mongodb的连接对象，我们直接用Object抽象。</p>
<h3 id="Post"><a href="#Post" class="headerlink" title="Post"></a>Post</h3><p>同样的，Holder来定义了Holder需要的接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 信息类接口</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Post</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 获取post个数</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@return</span> &#123;"status": "&lt;状态&gt;", "message": "&lt;错误描述&gt;", "data": &#123;"count": &lt;post个数&gt;&#125;&#125;</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> JSONObject <span class="title">getCount</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 获取所有的post</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@return</span> &#123;"status": "&lt;状态&gt;", "message": "&lt;错误描述&gt;", "data": [&#123;"id": &lt;post ID&gt;, "timestamp": &lt;post时间戳，单位：s&gt;, "content": "&lt;post内容&gt;"&#125;, ...]&#125;</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> JSONObject <span class="title">getAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 根据ID获取post</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> param &#123;"id": &lt;post ID&gt;&#125;</div><div class="line">	 * <span class="doctag">@return</span> &#123;"status": "&lt;状态&gt;", "message": "&lt;错误描述&gt;", "data": &#123;"id": &lt;post ID&gt;, "timestamp": &lt;post时间戳，单位：s&gt;, "content": "&lt;post内容&gt;"&#125;&#125;</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> JSONObject <span class="title">getById</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 添加post</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> param &#123;"content": "&lt;post内容&gt;"&#125;</div><div class="line">	 * <span class="doctag">@return</span> &#123;"status": "&lt;状态&gt;", "message": "&lt;错误描述&gt;", "data": &#123;"id": &lt;post ID&gt;, "timestamp": &lt;post时间戳，单位：s&gt;, "content": "&lt;post内容&gt;"&#125;&#125;</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> JSONObject <span class="title">add</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 修改post</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> param &#123;"id": &lt;post ID&gt;, "content": "&lt;post内容&gt;"&#125;</div><div class="line">	 * <span class="doctag">@return</span> &#123;"status": "&lt;状态&gt;", "message": "&lt;错误描述&gt;", "data": &#123;"id": &lt;post ID&gt;, "timestamp": &lt;post时间戳，单位：s&gt;, "content": "&lt;post内容&gt;"&#125;&#125;</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> JSONObject <span class="title">modify</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 删除post</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> param &#123;"id": &lt;post ID&gt;&#125;</div><div class="line">	 * <span class="doctag">@return</span> &#123;"status": "&lt;状态&gt;", "message": "&lt;错误描述&gt;", "data": &#123;"id": &lt;post ID&gt;&#125;&#125;</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> JSONObject <span class="title">remove</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="MysqlHolder"><a href="#MysqlHolder" class="headerlink" title="MysqlHolder"></a>MysqlHolder</h3><p>接下来，我们来具体说MysqlHolder如何遵循Holder接口规范来实现Mysql版Holder：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * mysql实体类</div><div class="line"> * &lt;p&gt;</div><div class="line"> * mysql实体类实现mysql连接和关闭，及数据库创建和销毁</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlHolder</span> <span class="keyword">implements</span> <span class="title">Holder</span> </span>&#123;</div><div class="line">	<span class="comment">/** 数据库连接 */</span></div><div class="line">	<span class="keyword">private</span> Connection _conn;</div><div class="line">	<span class="comment">/** 数据库名 */</span></div><div class="line">	<span class="keyword">private</span> String _database;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 构造函数</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> user mysql用户名</div><div class="line">	 * <span class="doctag">@param</span> password mysql用户密码</div><div class="line">	 * <span class="doctag">@param</span> database mysql数据库名</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MysqlHolder</span><span class="params">(String user, String password, String database)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 定义数据库接入类和连接地址</span></div><div class="line">		<span class="keyword">final</span> String driver = <span class="string">"com.mysql.cj.jdbc.Driver"</span>;</div><div class="line">		<span class="keyword">final</span> String url = <span class="string">"jdbc:mysql://localhost:3306/?characterEncoding=utf8&amp;useSSL=false"</span>;</div><div class="line">		</div><div class="line">		<span class="comment">// 连接数据库</span></div><div class="line">		Class.forName(driver);</div><div class="line">		_conn = DriverManager.getConnection(url, user, password);</div><div class="line">		</div><div class="line">		<span class="comment">// 保存数据库名</span></div><div class="line">		_database = database;</div><div class="line">		</div><div class="line">		<span class="comment">// 创建数据库</span></div><div class="line">		Statement statement = _conn.createStatement();</div><div class="line">		statement.execute(String.format(<span class="string">"CREATE DATABASE IF NOT EXISTS `%s` default character set utf8 COLLATE utf8_general_ci"</span>, _database));</div><div class="line">		statement.execute(String.format(<span class="string">"USE `%s`"</span>, _database));</div><div class="line">		statement.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">inst</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> _conn;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Statement statement = _conn.createStatement();</div><div class="line">		statement.execute(String.format(<span class="string">"DROP DATABASE IF EXISTS `%s`"</span>, _database));</div><div class="line">		statement.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		_conn.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中的构造函数是MysqlHolder需要注意设计的，把数据库连接需要的user和password及database作为参数传递过来是更好的设计，我们期望数据库user、password和database再整个应用中仅保留一份，显然不是这里，而且测试相关的数据库信息和正式的一定不一样，更说明这样设计的必要性。</p>
<p>说说这里边的注释，对于重载的函数，就不用再注释函数了，因为接口类已经详细注释了，必要的注释应该体现在函数内部的实现。</p>
<h3 id="MysqlPost"><a href="#MysqlPost" class="headerlink" title="MysqlPost"></a>MysqlPost</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * mysql信息类</div><div class="line"> * &lt;p&gt;</div><div class="line"> * mysql信息类实现对数据库表post的创建、添加、查询、修改和删除</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlPost</span> <span class="keyword">implements</span> <span class="title">Post</span> </span>&#123;</div><div class="line">	<span class="comment">/** 数据库表名 */</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String _table = <span class="string">"post"</span>;</div><div class="line"></div><div class="line">	<span class="comment">/** 数据库连接 */</span></div><div class="line">	<span class="keyword">private</span> Connection _conn;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 构造函数</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> conn 数据库连接</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MysqlPost</span><span class="params">(Connection conn)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 保存数据库连接</span></div><div class="line">		_conn = conn;</div><div class="line">		</div><div class="line">		<span class="comment">// 创建数据库表</span></div><div class="line">		Statement statement = _conn.createStatement();</div><div class="line">		statement.execute(String.format(<span class="string">"CREATE TABLE IF NOT EXISTS `%s` (`id` INT NOT NULL PRIMARY KEY AUTO_INCREMENT, `timestamp` INT NOT NULL, `content` TEXT NOT NULL)"</span>, _table));</div><div class="line">		statement.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> JSONObject <span class="title">getCount</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 查询数据库</span></div><div class="line">		Statement statement = _conn.createStatement();</div><div class="line">		ResultSet resultSet = statement.executeQuery(String.format(<span class="string">"SELECT COUNT(`id`) AS count FROM `%s`"</span>, _table));</div><div class="line">		resultSet.next();</div><div class="line">		<span class="keyword">int</span> count = resultSet.getInt(<span class="string">"count"</span>);</div><div class="line">		statement.close();</div><div class="line">		String resultStr = String.format(<span class="string">"&#123;\"status\": \"ok\", \"data\": &#123;\"count\": %d&#125;&#125;"</span>, count);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JSONObject(resultStr);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> JSONObject <span class="title">getAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 查询数据库</span></div><div class="line">		Statement statement = _conn.createStatement();</div><div class="line">		ResultSet resultSet = statement.executeQuery(String.format(<span class="string">"SELECT `id`,`timestamp`,`content` FROM `%s` ORDER BY `id` DESC"</span>, _table));</div><div class="line">		String cellStrs = <span class="string">""</span>;</div><div class="line">		<span class="keyword">while</span> (resultSet.next()) &#123;</div><div class="line">			<span class="keyword">int</span> id = resultSet.getInt(<span class="string">"id"</span>);</div><div class="line">			<span class="keyword">int</span> timestamp = resultSet.getInt(<span class="string">"timestamp"</span>);</div><div class="line">			String content = resultSet.getString(<span class="string">"content"</span>);</div><div class="line">			String cellStr = String.format(<span class="string">"&#123;\"id\": %d, \"timestamp\": %d, \"content\": \"%s\"&#125;"</span>, id, timestamp, content);</div><div class="line">			cellStrs += (cellStrs.isEmpty() ? <span class="string">""</span> : <span class="string">", "</span>) + cellStr;</div><div class="line">		&#125;</div><div class="line">		statement.close();</div><div class="line">		String resultStr = String.format(<span class="string">"&#123;\"status\": \"ok\", \"data\": [%s]&#125;"</span>, cellStrs);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JSONObject(resultStr);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JSONObject <span class="title">getById</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 校验id参数</span></div><div class="line">		Object[] idErr = Checker.checkParamId(param);</div><div class="line">		<span class="keyword">int</span> id = (Integer) idErr[<span class="number">0</span>];</div><div class="line">		JSONObject err = (JSONObject) idErr[<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (err != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> err;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="comment">// 查询数据库，如果没有数据返回错误</span></div><div class="line">		Statement statement = _conn.createStatement();</div><div class="line">		ResultSet resultSet = statement.executeQuery(String.format(<span class="string">"SELECT `id`,`timestamp`,`content` FROM `%s` WHERE `id`=%d LIMIT 1"</span>, _table, id));</div><div class="line">		<span class="keyword">if</span> (!resultSet.next()) &#123;</div><div class="line">			statement.close();</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"status\": \"none_target\", \"message\": \"`id` does not exist.\"&#125;"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">int</span> timestamp = resultSet.getInt(<span class="string">"timestamp"</span>);</div><div class="line">		String content = resultSet.getString(<span class="string">"content"</span>);</div><div class="line">		statement.close();</div><div class="line">		String resultStr = String.format(<span class="string">"&#123;\"status\": \"ok\", \"data\": &#123;\"id\": %d, \"timestamp\": %d, \"content\": \"%s\"&#125;&#125;"</span>, id, timestamp, content);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JSONObject(resultStr);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JSONObject <span class="title">add</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 校验content参数</span></div><div class="line">		Object[] contentErr = Checker.checkParamContent(param);</div><div class="line">		String content = (String) contentErr[<span class="number">0</span>];</div><div class="line">		JSONObject err = (JSONObject) contentErr[<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (err != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> err;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 获取当前系统时间</span></div><div class="line">		<span class="keyword">int</span> timestamp = (<span class="keyword">int</span>) (<span class="keyword">new</span> Date().getTime() / <span class="number">1000</span>);</div><div class="line"></div><div class="line">		<span class="comment">// 查询数据库</span></div><div class="line">		Statement statement = _conn.createStatement();</div><div class="line">		statement.executeUpdate(String.format(<span class="string">"INSERT INTO `%s` SET `timestamp`=%d,`content`=\"%s\""</span>, _table, timestamp, content), Statement.RETURN_GENERATED_KEYS);</div><div class="line">		ResultSet resultSet = statement.getGeneratedKeys();</div><div class="line">		resultSet.next();</div><div class="line">		<span class="keyword">int</span> id = resultSet.getInt(<span class="number">1</span>);</div><div class="line">		statement.close();</div><div class="line">		String resultStr = String.format(<span class="string">"&#123;\"status\": \"ok\", \"data\": &#123;\"id\": %d, \"timestamp\": %d, \"content\": \"%s\"&#125;&#125;"</span>, id, timestamp, content);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JSONObject(resultStr);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JSONObject <span class="title">modify</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 校验id参数</span></div><div class="line">		Object[] idErr = Checker.checkParamId(param);</div><div class="line">		<span class="keyword">int</span> id = (Integer) idErr[<span class="number">0</span>];</div><div class="line">		JSONObject err = (JSONObject) idErr[<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (err != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> err;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 校验content参数</span></div><div class="line">		Object[] contentErr = Checker.checkParamContent(param);</div><div class="line">		String content = (String) contentErr[<span class="number">0</span>];</div><div class="line">		err = (JSONObject) contentErr[<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (err != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> err;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="comment">// 查询数据库，如果没有数据修改返回错误</span></div><div class="line">		Statement statement = _conn.createStatement();</div><div class="line">		<span class="keyword">int</span> rowCount = statement.executeUpdate(String.format(<span class="string">"UPDATE `%s` SET `content`=\"%s\" WHERE `id`=%d"</span>, _table, content, id));</div><div class="line">		statement.close();</div><div class="line">		<span class="keyword">if</span> (rowCount != <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"status\": \"none_target\", \"message\": \"`id` does not exist.\"&#125;"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> getById(<span class="keyword">new</span> JSONObject(String.format(<span class="string">"&#123;\"id\": %d&#125;"</span>, id)));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> JSONObject <span class="title">remove</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 校验id参数</span></div><div class="line">		Object[] idErr = Checker.checkParamId(param);</div><div class="line">		<span class="keyword">int</span> id = (Integer) idErr[<span class="number">0</span>];</div><div class="line">		JSONObject err = (JSONObject) idErr[<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (err != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> err;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="comment">// 查询数据库，如果没有数据修改返回错误</span></div><div class="line">		Statement statement = _conn.createStatement();</div><div class="line">		<span class="keyword">int</span> rowCount = statement.executeUpdate(String.format(<span class="string">"DELETE FROM `%s` WHERE `id`=%d"</span>, _table, id));</div><div class="line">		statement.close();</div><div class="line">		<span class="keyword">if</span> (rowCount != <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"status\": \"none_target\", \"message\": \"`id` does not exist.\"&#125;"</span>);</div><div class="line">		&#125;</div><div class="line">		String resultStr = String.format(<span class="string">"&#123;\"status\": \"ok\", \"data\": &#123;\"id\": %d&#125;&#125;"</span>, id);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JSONObject(resultStr);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MysqlPost实际上是对应mysql的post表，既然Holder我们已经定义了，MysqlPost应当仅关注post相关的实现，数据库的连接对象将作为参数传入。</p>
<p>前面说到，数据库的参数应该传入，对于MysqlPost，post的表名直接定义常量即可，不管是正式还是测试版，这个名称没有必要改变。</p>
<p>对于函数内注释，我们应该有必要的注释，但是没有必要逐行注释，原则上，函数内如逻辑上分为多个功能块，我么应该对各个功能块注释，格式化的角度，各功能块换行。</p>
<h3 id="MessageCreator"><a href="#MessageCreator" class="headerlink" title="MessageCreator"></a>MessageCreator</h3><p>现在改说MessageCreator，MessageCreator模式上是工厂，使用者需要明确告诉MessageCeator是想创建mysql的Message还是其他。</p>
<p>这里衍生一下，为什么不是抽象工厂模式。抽象工厂模式的应用场景对于hz-message应该是，hz-message运行过程中，需要动态切换mysql message和moongodb message，显示对于hz-message没有这样的需求，所有不是抽象工厂模式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * message对象创建类</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageCreator</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 创建mysql类message</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@param</span> user mysql用户名</div><div class="line">	 * <span class="doctag">@param</span> password mysql用户密码</div><div class="line">	 * <span class="doctag">@param</span> database mysql数据库名</div><div class="line">	 * <span class="doctag">@return</span> message对象</div><div class="line">	 * <span class="doctag">@throws</span> Exception 错误异常</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title">createMessageByMysql</span><span class="params">(String user, String password, String database)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Holder holder = <span class="keyword">new</span> MysqlHolder(user, password, database);</div><div class="line">		Post post = <span class="keyword">new</span> MysqlPost((Connection) holder.inst());</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Message(holder, post);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Server测试"><a href="#Server测试" class="headerlink" title="Server测试"></a>Server测试</h2><p>到此，我们把hz-messag的设计多做的七七八八了，有些都顺手实现了，接下来，我们在具体功能实现的时候，应该并行单元测试了。</p>
<p>单元测试和QA做的事是两回事，单元测试是开发分内的事。</p>
<p>单元测试不仅确保每个模块的功能实现正确没有bug，同时还检验整个工程的架构的设计是否合理，如果单元测试的覆盖做不到每个功能的全面覆盖及唯一覆盖，那我们应该反过来具体检查设计是否合理，具体的，模块切分是否合理，模块间是否功能交叉，模块的接口设计是否具备好的扩展性。</p>
<p>单元测试的覆盖分两个维度：</p>
<ul>
<li>是否都覆盖</li>
<li>是否存在交叉覆盖</li>
</ul>
<p>不想设计自顶而下，单元测试则是自下而上的实现。</p>
<h3 id="ConverteTest"><a href="#ConverteTest" class="headerlink" title="ConverteTest"></a>ConverteTest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 测试Converter</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConverterTest</span> </span>&#123;</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_str2json</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// 测试输入空的参数（null和""），返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 测试输入非法参数（非json字符串），返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 测试输入合法参数（json字符串），返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_json2str</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// 测试输入空参数（null），返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 测试输入合法参数，返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="CheckerTest"><a href="#CheckerTest" class="headerlink" title="CheckerTest"></a>CheckerTest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 测试Checker</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckerTest</span> </span>&#123;</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_checkParamType</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// 测试空参数</span></div><div class="line">		Object[] res = Checker.checkParamType(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"lost_parameter"</span>));</div><div class="line">		</div><div class="line">		<span class="comment">// 测试非法key参数</span></div><div class="line">		res = Checker.checkParamType(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"abcd\": \"1234\"&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"lost_parameter"</span>));</div><div class="line">		res = Checker.checkParamType(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"Type\": \"1234\"&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"lost_parameter"</span>));</div><div class="line">		</div><div class="line">		<span class="comment">// 测试非法value参数</span></div><div class="line">		res = Checker.checkParamType(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"type\": 1234&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"invalid_parameter"</span>));</div><div class="line">		res = Checker.checkParamType(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"type\": \"\"&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"invalid_parameter"</span>));</div><div class="line">		</div><div class="line">		<span class="comment">// 测试合法参数</span></div><div class="line">		res = Checker.checkParamType(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"type\": \"1234\"&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>].equals(<span class="string">"1234"</span>) &amp;&amp; res[<span class="number">1</span>] == <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_checkParamId</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// 测试空参数</span></div><div class="line">		Object[] res = Checker.checkParamId(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"lost_parameter"</span>));</div><div class="line">		</div><div class="line">		<span class="comment">// 测试非法key参数</span></div><div class="line">		res = Checker.checkParamId(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"abcd\": 1234&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"lost_parameter"</span>));</div><div class="line">		res = Checker.checkParamId(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"Id\": 1234&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"lost_parameter"</span>));</div><div class="line"></div><div class="line">		<span class="comment">// 测试非法value参数</span></div><div class="line">		res = Checker.checkParamId(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"id\": \"1234\"&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"invalid_parameter"</span>));</div><div class="line">		</div><div class="line">		<span class="comment">// 测试合法参数</span></div><div class="line">		res = Checker.checkParamId(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"id\": 1234&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>].equals(<span class="number">1234</span>) &amp;&amp; res[<span class="number">1</span>] == <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_checkParamContent</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// 测试空参数</span></div><div class="line">		Object[] res = Checker.checkParamContent(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"lost_parameter"</span>));</div><div class="line"></div><div class="line">		<span class="comment">// 测试非法key参数</span></div><div class="line">		res = Checker.checkParamContent(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"abcd\": \"1234\"&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"lost_parameter"</span>));</div><div class="line">		res = Checker.checkParamContent(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"Content\": \"1234\"&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"lost_parameter"</span>));</div><div class="line"></div><div class="line">		<span class="comment">// 测试非法value参数</span></div><div class="line">		res = Checker.checkParamContent(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"content\": 1234&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"invalid_parameter"</span>));</div><div class="line">		res = Checker.checkParamContent(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"content\": \"\"&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>] == <span class="keyword">null</span> &amp;&amp; ((JSONObject) res[<span class="number">1</span>]).getString(<span class="string">"status"</span>).equals(<span class="string">"invalid_parameter"</span>));</div><div class="line"></div><div class="line">		<span class="comment">// 测试合法参数</span></div><div class="line">		res = Checker.checkParamContent(<span class="keyword">new</span> JSONObject(<span class="string">"&#123;\"content\": \"1234\"&#125;"</span>));</div><div class="line">		assertTrue(res[<span class="number">0</span>].equals(<span class="string">"1234"</span>) &amp;&amp; res[<span class="number">1</span>] == <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="MysqlHolderTest"><a href="#MysqlHolderTest" class="headerlink" title="MysqlHolderTest"></a>MysqlHolderTest</h3><p>我们测试的主要是接口实现，所有HolderTest不用测试了。</p>
<p>测试，原则上我们仅覆盖接口，或者说是public方法。</p>
<p>Java单元测试，我们使用org.junit。</p>
<p>MysqlHolderTest的框架看上去是这样的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 测试MysqlHolder</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlHolderTest</span> </span>&#123;</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_inst</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建MysqlHolder对象</span></div><div class="line">		<span class="comment">// 注意：要使用测试数据库，和线网数据库分开</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	</div><div class="line">		<span class="comment">// 测试MysqlHolder.inst返回的对象是否为mysql连接对象</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 销毁MysqlHolder，确保测试数据库销毁，不影响其他测试</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;		</div><div class="line">		<span class="comment">// 创建MysqlHolder对象</span></div><div class="line">		<span class="comment">// 注意：要使用测试数据库，和线网数据库分开</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 获取数据库连接（MysqlHolder.inst()），用于访问数据库验证detroy方法是否正确执行</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 测试数据库没有销毁，通过数据连接conn直接查询数据库，比如"SHOW TABLES"，看有没有异常</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 执行MysqlHolder.destroy</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 测试数据库已经销毁，通过数据连接conn直接查询数据库，比如"SHOW TABLES"，看有没有异常</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建MysqlHolder对象</span></div><div class="line">		<span class="comment">// 注意：要使用测试数据库，和线网数据库分开</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 测试数据库连接没有关闭</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 执行MysqlHolder.close</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 测试数据库连接已经关闭</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="MysqlPostTest"><a href="#MysqlPostTest" class="headerlink" title="MysqlPostTest"></a>MysqlPostTest</h3><p>MysqlPostTest用来测试MysqlPost的接口函数，看起来是这样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 测试MysqlPost类</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlPostTest</span> </span>&#123;</div><div class="line">	<span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_getCount</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建MysqlHolder对象</span></div><div class="line">		<span class="comment">// 创建MysqlPost对象</span></div><div class="line">		<span class="comment">// 注意：要使用测试数据库，和线网数据库分开</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	</div><div class="line">		<span class="comment">// 执行MysqlPost.getCount()，测试初始post个数为0</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 添加一组测试post</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 执行MysqlPost.getCount()，测试post个数为添加的post个数</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 销毁MysqlHolder，确保测试数据库销毁，不影响其他测试</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_getAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建MysqlHolder对象</span></div><div class="line">		<span class="comment">// 创建MysqlPost对象</span></div><div class="line">		<span class="comment">// 注意：要使用测试数据库，和线网数据库分开</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 执行MysqlPost.getAll()，测试初始的post为空</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 添加一组测试post</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 执行MysqlPost.getAll()</span></div><div class="line">		<span class="comment">// 测试获取的post数组：content和添加的post数组一致，但是时间顺序依次递减，且和添加的post数组顺序相反</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 销毁MysqlHolder，确保测试数据库销毁，不影响其他测试</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_getById</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建MysqlHolder对象</span></div><div class="line">		<span class="comment">// 创建MysqlPost对象</span></div><div class="line">		<span class="comment">// 注意：要使用测试数据库，和线网数据库分开</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">        <span class="comment">// 指定任意一个post id执行MysqlPost.getById()，测试返回期望的错误码</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">        <span class="comment">// 添加一组测试post，并获取所有的post（包含post id）</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">        <span class="comment">// 枚举每一个post，获取post id，分别执行MysqlPost.getById()，测试返回的post数据和枚举的post一致</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 销毁MysqlHolder，确保测试数据库销毁，不影响其他测试</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Test</span>	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_add</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建MysqlHolder对象</span></div><div class="line">		<span class="comment">// 创建MysqlPost对象</span></div><div class="line">		<span class="comment">// 注意：要使用测试数据库，和线网数据库分开</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">        <span class="comment">// 执行MysqlPost.add()，添加一个测试post</span></div><div class="line">		<span class="comment">// 测试返回的状态ok</span></div><div class="line">		<span class="comment">// 测试返回的id合法</span></div><div class="line">		<span class="comment">// 测试返回的timestamp合法</span></div><div class="line">		<span class="comment">// 测试返回的content和添加的一致</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 销毁MysqlHolder，确保测试数据库销毁，不影响其他测试</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_modify</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建MysqlHolder对象</span></div><div class="line">		<span class="comment">// 创建MysqlPost对象</span></div><div class="line">		<span class="comment">// 注意：要使用测试数据库，和线网数据库分开</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">        <span class="comment">// 添加一个测试post，并获取id和timestamp</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">        <span class="comment">// 根据获取的id，执行MysqlPost.modify()</span></div><div class="line">		<span class="comment">// 测试返回的status为ok</span></div><div class="line">		<span class="comment">// 测试后返回的timestamp和添加的timestamp一致</span></div><div class="line">		<span class="comment">// 测试返回的content正确</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">		<span class="comment">// 销毁MysqlHolder，确保测试数据库销毁，不影响其他测试</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_remove</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建MysqlHolder对象</span></div><div class="line">		<span class="comment">// 创建MysqlPost对象</span></div><div class="line">		<span class="comment">// 注意：要使用测试数据库，和线网数据库分开</span></div><div class="line">		<span class="comment">// TOD</span></div><div class="line">		</div><div class="line">		<span class="comment">// 指定任意一个id，执行MysqlPost.remove()</span></div><div class="line">		<span class="comment">// 测试返回的状态none_target</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">        <span class="comment">// 添加一个测试post，获取post id</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 获取添加的post id</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 根据获取的post id，执行MysqlPost.remove()</span></div><div class="line">		<span class="comment">// 测试返回的状态ok</span></div><div class="line">		<span class="comment">// 测试返回的id和删除的id一致</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line"></div><div class="line">		<span class="comment">// 销毁MysqlHolder，确保测试数据库销毁，不影响其他测试</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="MessageTest"><a href="#MessageTest" class="headerlink" title="MessageTest"></a>MessageTest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 测试Message</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageTest</span> </span>&#123;</div><div class="line">	<span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_request</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 创建Message对象</span></div><div class="line">		<span class="comment">// 注意：创建Messae对象需要的Hodler和Post对象，可以本地模拟Holder和Post对相关，不用使用MysqlHolder和MysqlPost，MysqlHolder和MysqlPost有自己单独的测试程序</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">		</div><div class="line">        <span class="comment">// 执行Message.request()</span></div><div class="line">		<span class="comment">// 测试输入合法参数&#123;"type": "get_post_count"&#125;，返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">        </div><div class="line">        <span class="comment">// 执行Message.request()</span></div><div class="line">        <span class="comment">// 测试输入合法参数&#123;"type": "get_all_post"&#125;，返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">        </div><div class="line">        <span class="comment">// 执行Message.request()</span></div><div class="line">        <span class="comment">// 测试输入合法参数&#123;"type": "get_post_by_id"&#125;，返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">        </div><div class="line">        <span class="comment">// 执行Message.request()</span></div><div class="line">        <span class="comment">// 测试输入合法参数&#123;"type": "add_post"&#125;，返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">        </div><div class="line">        <span class="comment">// 执行Message.request()</span></div><div class="line">        <span class="comment">// 测试输入合法参数&#123;"type": "modify_post"&#125;，返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">        </div><div class="line">        <span class="comment">// 执行Message.request()</span></div><div class="line">        <span class="comment">// 测试输入合法参数&#123;"type": "remove_post"&#125;，返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">        </div><div class="line">        <span class="comment">// 执行Message.request()</span></div><div class="line">        <span class="comment">// 测试输入合法参数&#123;"type": "other"&#125;，返回期望值</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="MessageCreatorTest"><a href="#MessageCreatorTest" class="headerlink" title="MessageCreatorTest"></a>MessageCreatorTest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 测试MessageCreator</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageCreatorTest</span> </span>&#123;</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_createMessageByMysql</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// MessageCreator.createMessageByMysql，创建Message对象</span></div><div class="line">		<span class="comment">// 测试返回的Message对象是否为空</span></div><div class="line">		<span class="comment">// TODO</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>大家可以在这里<a href="https://github.com/wuqingtao/hz-message" target="_blank" rel="external">hz-message</a>找到整个工程的实现版本，其中包含了另外的node、php和python版本，也包含了完整的部署、启停脚本。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wuqingtao.github.io/blog/2016/12/05/talk-about-design/" data-id="cixr09bhu0000ewl401cetwea" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2016/12/">December 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2016/12/05/talk-about-design/">浅谈设计和架构过程</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 hongzhong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>

  </div>
</body>
</html>